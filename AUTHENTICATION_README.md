# ๐ ุฏููู ูุธุงู ุงููุตุงุฏูุฉ ูุงูุชุณุฌูู - Authentication Guide

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ูุดุฑุญ ูุธุงู ุงููุตุงุฏูุฉ ุงููุงูู ูู ุชุทุจูู Talk Moneyุ ุจูุง ูู ุฐูู ุชุณุฌูู ุงูุฏุฎููุ ุฅูุดุงุก ุงูุญุณุงุจุ ุงูุชุญูู ูู ุงููุณุชุฎุฏูุ ูุฌููุน ุงูุฏูุงู ูุงูุขููุงุช ุงููุณุชุฎุฏูุฉ.

---

## ๐๏ธ ุงูุจููุฉ ุงููุนูุงุฑูุฉ (Architecture)

### 1. **AuthContext** (`app/context/AuthContext.js`)
ุงูุณูุงู ุงูุฑุฆูุณู ูุฅุฏุงุฑุฉ ุญุงูุฉ ุงููุตุงุฏูุฉ ูู ุงูุชุทุจูู ุจุฃูููู.

### 2. **ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู** (`app/login/page.js`)
ูุงุฌูุฉ ุงููุณุชุฎุฏู ูุชุณุฌูู ุงูุฏุฎูู ูุฅูุดุงุก ุงูุญุณุงุจ.

### 3. **ุตูุญุงุช ูุญููุฉ** (Protected Pages)
- `app/home/page.js` - ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
- `app/reports/page.js` - ุตูุญุฉ ุงูุชูุงุฑูุฑ
- `app/admin/page.js` - ุตูุญุฉ ุงูุฅุฏุงุฑุฉ
- `app/settings/page.js` - ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช

---

## ๐ ุงูููููุงุช ุงูุฑุฆูุณูุฉ

### 1. **AuthContext** - ุงูุณูุงู ุงูุฑุฆูุณู ูููุตุงุฏูุฉ

#### ุงูููู: `app/context/AuthContext.js`

#### ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:

##### ุฃ. **checkUserExists(uid, retries = 3)**
```javascript
// ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore
const checkUserExists = async (uid, retries = 3)
```

**ุงููุธููุฉ:**
- ุงูุชุญูู ูู ูุฌูุฏ ูุณุชูุฏ ุงููุณุชุฎุฏู ูู collection `users` ูู Firestore
- ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุญุชู 3 ูุฑุงุช ูู ุญุงูุฉ ุงููุดู
- ุฅุฑุฌุงุน `true` ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ููุฌูุฏุ `false` ุฅุฐุง ูู ููู ููุฌูุฏ

**ุงููุนุงููุงุช:**
- `uid`: ูุนุฑู ุงููุณุชุฎุฏู ุงููุฑูุฏ
- `retries`: ุนุฏุฏ ูุญุงููุงุช ุฅุนุงุฏุฉ ุงููุญุงููุฉ (ุงูุชุฑุงุถู: 3)

**ุงูุงุณุชุฎุฏุงู:**
- ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูุจู ุงูุณูุงุญ ุจุงูุฏุฎูู
- ุงูุชุญูู ุจุนุฏ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ

---

##### ุจ. **saveUserToFirestore(user, displayNameFallback, isNewUser)**
```javascript
// ุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู Firestore
const saveUserToFirestore = async (user, displayNameFallback = null, isNewUser = false)
```

**ุงููุธููุฉ:**
- ุญูุธ ุฃู ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู Firestore
- ุฅุฏุงุฑุฉ `role` ุงููุณุชุฎุฏู (user/admin)
- ุฅุถุงูุฉ `createdAt` ูููุณุชุฎุฏููู ุงูุฌุฏุฏ ููุท

**ุงููุนุงููุงุช:**
- `user`: ูุงุฆู ุงููุณุชุฎุฏู ูู Firebase Auth
- `displayNameFallback`: ุงุณู ุจุฏูู ุฅุฐุง ูู ููู ููุฌูุฏ ูู user object
- `isNewUser`: `true` ุฅุฐุง ูุงู ูุณุชุฎุฏู ุฌุฏูุฏุ `false` ุฅุฐุง ูุงู ููุฌูุฏ

**ุงูุจูุงูุงุช ุงููุญููุธุฉ:**
```javascript
{
  uid: user.uid,
  name: displayName,
  email: user.email,
  photoURL: user.photoURL || null,
  role: "user" | "admin", // ุงูุชุฑุงุถู: "user"
  createdAt: serverTimestamp(), // ููุท ูููุณุชุฎุฏููู ุงูุฌุฏุฏ
  updatedAt: serverTimestamp()
}
```

**ุงูุงุณุชุฎุฏุงู:**
- ุนูุฏ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
- ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ุจู Google
- ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู

---

##### ุฌ. **handleUnauthorizedUser()**
```javascript
// ุชุณุฌูู ุงูุฎุฑูุฌ ูุฅุนุงุฏุฉ ุงูุชูุฌูู
const handleUnauthorizedUser = async ()
```

**ุงููุธููุฉ:**
- ุชุณุฌูู ุงูุฎุฑูุฌ ูู Firebase Auth
- ุญุฐู ุงูุจูุงูุงุช ูู localStorage
- ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู

**ุงูุจูุงูุงุช ุงููุญุฐููุฉ:**
- `userName`
- `userPhoto`
- `rememberMe`

**ุงูุงุณุชุฎุฏุงู:**
- ุนูุฏ ูุดู ุงูุชุญูู ูู ุงููุณุชุฎุฏู
- ุนูุฏ ุชุณุฌูู ุงูุฎุฑูุฌ ูุฏููุงู

---

##### ุฏ. **signInWithGoogle()**
```javascript
// ุชุณุฌูู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู Google
const signInWithGoogle = async ()
```

**ุงููุธููุฉ:**
- ุชุณุฌูู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู Google OAuth
- ูุชุญ ูุงูุฐุฉ ููุจุซูุฉ ูุงุฎุชูุงุฑ ุญุณุงุจ Google
- ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore
- ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ ุฅุฐุง ูู ููู ููุฌูุฏ
- ุญูุธ ุงูุจูุงูุงุช ูู localStorage

**ุฎุทูุงุช ุงูุนูู:**
1. ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุฃู ุญุณุงุจ ุณุงุจู
2. ูุชุญ ูุงูุฐุฉ Google OAuth
3. ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore
4. ุฅุฐุง ูู ููู ููุฌูุฏ: ุฅูุดุงุก ูุณุชูุฏ ุฌุฏูุฏ
5. ุฅุฐุง ูุงู ููุฌูุฏ: ุชุญุฏูุซ ุงูุจูุงูุงุช ููุท
6. ุญูุธ ุงูุจูุงูุงุช ูู localStorage
7. ุงูุชูุฌูู ุฅูู `/home`

**ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
- `auth/popup-closed-by-user`: ุงููุณุชุฎุฏู ุฃุบูู ุงููุงูุฐุฉ (ูุง ุชุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ)
- `auth/popup-blocked`: ุชู ุญุธุฑ ุงููุงูุฐุฉ ุงูููุจุซูุฉ
- `auth/operation-not-allowed`: Google sign-in ุบูุฑ ููุนูู
- `auth/unauthorized-domain`: ุงููุทุงู ุบูุฑ ูุตุฑุญ ุจู
- `auth/network-request-failed`: ูุดููุฉ ูู ุงูุงุชุตุงู

---

##### ูู. **onAuthStateChanged Listener**
```javascript
// ุงูุงุณุชูุงุน ูุชุบููุฑุงุช ุญุงูุฉ ุงููุตุงุฏูุฉ
useEffect(() => {
  const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
    // ...
  });
}, []);
```

**ุงููุธููุฉ:**
- ุงูุงุณุชูุงุน ุงูุชููุงุฆู ูุชุบููุฑุงุช ุญุงูุฉ ุงููุตุงุฏูุฉ
- ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore ุนูุฏ ูู ุชุบููุฑ
- ุชุญุฏูุซ state ุชููุงุฆูุงู

**ุงูุณููู:**
- ุฅุฐุง ูุงู `isGoogleSignInRef.current === true`: ูุชุฌุงูู ุงูุชุญุฏูุซ (Google sign-in ูุฏูุฑ ูู ุดูุก)
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ููุฌูุฏ: ูุชุญูู ูู Firestore
- ุฅุฐุง ูู ููู ููุฌูุฏ ูู Firestore: ุชุณุฌูู ุงูุฎุฑูุฌ ุชููุงุฆูุงู
- ุฅุฐุง ูุงู ููุฌูุฏ: ุชุญุฏูุซ state ูุญูุธ ูู localStorage

---

#### ุงูููู ุงููุชุงุญุฉ ูู AuthContext:

```javascript
const { user, loading, signOut, signInWithGoogle } = useAuth();
```

- **`user`**: ูุงุฆู ุงููุณุชุฎุฏู ูู Firebase Auth (ุฃู `null`)
- **`loading`**: ุญุงูุฉ ุงูุชุญููู (`true` ุฃุซูุงุก ุฌูุจ ุงูุจูุงูุงุช)
- **`signOut`**: ุฏุงูุฉ ุชุณุฌูู ุงูุฎุฑูุฌ
- **`signInWithGoogle`**: ุฏุงูุฉ ุชุณุฌูู ุงูุฏุฎูู ุจู Google

---

### 2. **ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู** - Login Page

#### ุงูููู: `app/login/page.js`

#### ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:

##### ุฃ. **checkUserExists(uid, retries = 3)**
```javascript
// ููุณ ุงูุฏุงูุฉ ูู AuthContext - ููุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู
const checkUserExists = useCallback(async (uid, retries = 3), []);
```

**ุงูุงุณุชุฎุฏุงู:**
- ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู
- ููุน ุชุณุฌูู ุงูุฏุฎูู ูููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู ูู Firestore

---

##### ุจ. **saveUserToFirestore(user, displayNameFallback, isNewUser)**
```javascript
// ููุณ ุงูุฏุงูุฉ ูู AuthContext - ูุญูุธ ุงููุณุชุฎุฏู
const saveUserToFirestore = useCallback(async (user, displayNameFallback = null, isNewUser = false), []);
```

**ุงูุงุณุชุฎุฏุงู:**
- ุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู ุนูุฏ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
- ุชุญุฏูุซ ุงูุจูุงูุงุช ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู

---

##### ุฌ. **validateInputs()**
```javascript
// ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ุงููุฏุฎูุฉ
const validateInputs = useCallback(() => {
  // ุงูุชุญูู ูู:
  // 1. ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ
  // 2. ุตุญุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
  // 3. ุทูู ูููุฉ ุงููุฑูุฑ (6 ุฃุญุฑู ุนูู ุงูุฃูู)
  // 4. ุฅุฏุฎุงู ุงูุงุณู ุนูุฏ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
}, [email, password, name, isLogin, showError]);
```

**ุงูุชุญููุงุช:**
- โ ุฌููุน ุงูุญููู ููููุกุฉ
- โ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุจุตูุบุฉ ุตุญูุญุฉ
- โ ูููุฉ ุงููุฑูุฑ 6 ุฃุญุฑู ุนูู ุงูุฃูู
- โ ุงูุงุณู ูุทููุจ ุนูุฏ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ

---

##### ุฏ. **handleSubmit(e)**
```javascript
// ูุนุงูุฌุฉ ุฅุฑุณุงู ุงููููุฐุฌ (ุชุณุฌูู ุงูุฏุฎูู ุฃู ุฅูุดุงุก ุญุณุงุจ)
const handleSubmit = useCallback(async (e) => {
  e.preventDefault();
  // ...
}, [isLogin, email, password, name, ...]);
```

**ุงููุธููุฉ:**
ูุนุงูุฌุฉ ุชุณุฌูู ุงูุฏุฎูู ุฃู ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ

**ุณูุฑ ุงูุนูู ูุชุณุฌูู ุงูุฏุฎูู:**
1. ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช (`validateInputs`)
2. ุชุณุฌูู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู `signInWithEmailAndPassword`
3. ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore
4. ุฅุฐุง ูู ููู ููุฌูุฏ: ุชุณุฌูู ุงูุฎุฑูุฌ ูุนุฑุถ ุฎุทุฃ
5. ุญูุธ ุงูุจูุงูุงุช ูู localStorage
6. ุงูุชูุฌูู ุฅูู `/home`

**ุณูุฑ ุงูุนูู ูุฅูุดุงุก ุญุณุงุจ:**
1. ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
2. ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุฃู ุญุณุงุจ ุณุงุจู
3. ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ ุจุงุณุชุฎุฏุงู `createUserWithEmailAndPassword`
4. ุชุญุฏูุซ ุงูุงุณู ูู profile (`updateProfile`)
5. ุญูุธ ุงููุณุชุฎุฏู ูู Firestore (`saveUserToFirestore`)
6. ุงูุชุญูู ูู ุฅูุดุงุก ุงููุณุชูุฏ (ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ)
7. ุญูุธ ุงูุจูุงูุงุช ูู localStorage
8. ุงูุชูุฌูู ุฅูู `/home`

**ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
- `auth/invalid-credential`: ุงูุจุฑูุฏ ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ
- `auth/user-not-found`: ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ
- `auth/wrong-password`: ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ
- `auth/invalid-email`: ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ุตุญูุญ
- `auth/email-already-in-use`: ุงูุจุฑูุฏ ูุณุชุฎุฏู ุจุงููุนู
- `auth/weak-password`: ูููุฉ ุงููุฑูุฑ ุถุนููุฉ
- `auth/network-request-failed`: ูุดููุฉ ูู ุงูุงุชุตุงู
- `auth/too-many-requests`: ุชุฌุงูุฒ ุนุฏุฏ ุงููุญุงููุงุช
- `auth/user-disabled`: ุงูุญุณุงุจ ูุนุทู
- `auth/operation-not-allowed`: ุงูุทุฑููุฉ ุบูุฑ ููุนููุฉ

---

#### State Management ูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู:

```javascript
const [isLogin, setIsLogin] = useState(true); // Toggle ุจูู login/signup
const [email, setEmail] = useState("");
const [password, setPassword] = useState("");
const [name, setName] = useState("");
const [showPassword, setShowPassword] = useState(false);
const [loading, setLoading] = useState(false);
```

---

#### ุงูุชูุฌูู ุงูุชููุงุฆู:

```javascript
// ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ุจุงููุนูุ ุงูุชูุฌูู ุฅูู /home
useEffect(() => {
  if (user) {
    router.replace("/home");
  }
}, [user, router]);
```

---

### 3. **ุงูุตูุญุงุช ุงููุญููุฉ** - Protected Pages

ุฌููุน ุงูุตูุญุงุช ุงูุชุงููุฉ ุชุณุชุฎุฏู **Auth Guard** ููุชุญูู ูู ุงููุณุชุฎุฏู:

#### ุฃ. **ุตูุญุฉ ุงูุฑุฆูุณูุฉ** (`app/home/page.js`)

**ุงูุชุญูู:**
```javascript
useEffect(() => {
  if (!user) {
    router.replace("/login");
    return;
  }
  // ุชุญููู ุงูุจูุงูุงุช...
}, [user, router]);
```

**ุงููุธุงุฆู:**
- ุนุฑุถ ุงูุตูุญุฉ ููุฑุงู ูุน ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
- ุชุญููู ุงูุจูุงูุงุช ุงูุฅุถุงููุฉ ูู ุงูุฎูููุฉ (role, expenses, incomes)
- ุฌูุจ `userRole` ูู Firestore

---

#### ุจ. **ุตูุญุฉ ุงูุชูุงุฑูุฑ** (`app/reports/page.js`)

**ุงูุชุญูู:**
```javascript
useEffect(() => {
  const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
    if (currentUser) {
      // ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      
      if (!userDoc.exists()) {
        // ุชุณุฌูู ุงูุฎุฑูุฌ ูุฅุนุงุฏุฉ ุงูุชูุฌูู
        await signOut(auth);
        router.push("/login");
        return;
      }
      
      // ูุชุงุจุนุฉ ุงูุชุญููู
      setUser(currentUser);
      setUserRole(userData.role || "user");
    } else {
      router.push("/login");
    }
  });
}, [router]);
```

**ุงููุธุงุฆู:**
- ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore
- ุฌูุจ `userRole` ูู Firestore
- ุชุณุฌูู ุงูุฎุฑูุฌ ุชููุงุฆูุงู ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ููุฌูุฏ

---

#### ุฌ. **ุตูุญุฉ ุงูุฅุฏุงุฑุฉ** (`app/admin/page.js`)

**ุงูุชุญูู:**
```javascript
useEffect(() => {
  const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
    if (currentUser) {
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      
      if (!userDoc.exists()) {
        await signOut(auth);
        router.push("/login");
        return;
      }
      
      const userData = userDoc.data();
      
      // ุงูุชุญูู ูู role
      if (userData?.role !== "admin") {
        router.push("/home"); // ุชูุฌูู ุงููุณุชุฎุฏููู ุงูุนุงุฏููู
        return;
      }
      
      setUserRole(userData?.role || "admin");
    } else {
      router.push("/login");
    }
  });
}, [router]);
```

**ุงููุธุงุฆู:**
- ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore
- **ุงูุชุญูู ูู role**: ููุท `admin` ููููู ุงููุตูู
- ุชูุฌูู ุงููุณุชุฎุฏููู ุงูุนุงุฏููู ุฅูู `/home`

---

#### ุฏ. **ุตูุญุฉ ุงูุฅุนุฏุงุฏุงุช** (`app/settings/page.js`)

**ุงูุชุญูู:**
ูุดุงุจู ูุตูุญุฉ ุงูุชูุงุฑูุฑ - ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore

---

### 4. **ุตูุญุฉ Landing** (`app/page.js`)

**ุงููุธููุฉ:**
- ุงูุชุญูู ูู ุญุงูุฉ ุงููุตุงุฏูุฉ ุนูุฏ ูุชุญ ุงูุชุทุจูู
- ุงูุชูุฌูู ุงูููุฑู:
  - ุฅุฐุง ูุงู ูุณุฌู ุฏุฎูู โ `/home`
  - ุฅุฐุง ูู ููู ูุณุฌู ุฏุฎูู โ `/login`

**ุงูููุฏ:**
```javascript
useEffect(() => {
  const unsubscribe = onAuthStateChanged(auth, (user) => {
    if (user) {
      router.replace("/home");
    } else {
      router.replace("/login");
    }
  });
}, [router]);
```

---

## ๐ ุชุฏูู ุงูุนูู (Flow)

### 1. **ุชุฏูู ุชุณุฌูู ุงูุฏุฎูู (Email/Password)**

```
ุงููุณุชุฎุฏู ูุฏุฎู ุงูุจูุงูุงุช
    โ
validateInputs() - ุงูุชุญูู ูู ุงูุตุญุฉ
    โ
signInWithEmailAndPassword() - ุชุณุฌูู ุงูุฏุฎูู
    โ
checkUserExists() - ุงูุชุญูู ูู Firestore
    โ
ุฅุฐุง ููุฌูุฏ: ุญูุธ ูู localStorage โ ุงูุชูุฌูู ุฅูู /home
ุฅุฐุง ุบูุฑ ููุฌูุฏ: ุชุณุฌูู ุงูุฎุฑูุฌ โ ุนุฑุถ ุฎุทุฃ
```

---

### 2. **ุชุฏูู ุฅูุดุงุก ุงูุญุณุงุจ (Email/Password)**

```
ุงููุณุชุฎุฏู ูุฏุฎู ุงูุจูุงูุงุช
    โ
validateInputs() - ุงูุชุญูู ูู ุงูุตุญุฉ
    โ
signOut() - ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุฃู ุญุณุงุจ ุณุงุจู
    โ
createUserWithEmailAndPassword() - ุฅูุดุงุก ุญุณุงุจ
    โ
updateProfile() - ุชุญุฏูุซ ุงูุงุณู
    โ
saveUserToFirestore() - ุญูุธ ูู Firestore
    โ
checkUserExists() - ุงูุชุญูู ูู ุงูุฅูุดุงุก (ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ)
    โ
ุญูุธ ูู localStorage โ ุงูุชูุฌูู ุฅูู /home
```

---

### 3. **ุชุฏูู ุชุณุฌูู ุงูุฏุฎูู (Google)**

```
ุงููุณุชุฎุฏู ูููุฑ ุนูู "ุชุณุฌูู ุงูุฏุฎูู ุจู Google"
    โ
signOut() - ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุฃู ุญุณุงุจ ุณุงุจู
    โ
signInWithPopup() - ูุชุญ ูุงูุฐุฉ Google
    โ
ุงููุณุชุฎุฏู ูุฎุชุงุฑ ุญุณุงุจ Google
    โ
checkUserExists() - ุงูุชุญูู ูู Firestore
    โ
ุฅุฐุง ุบูุฑ ููุฌูุฏ:
    saveUserToFirestore(isNewUser=true) - ุฅูุดุงุก ุญุณุงุจ
    checkUserExists() - ุงูุชุญูู (ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ)
ุฅุฐุง ููุฌูุฏ:
    saveUserToFirestore(isNewUser=false) - ุชุญุฏูุซ ุงูุจูุงูุงุช
    โ
ุญูุธ ูู localStorage โ ุงูุชูุฌูู ุฅูู /home
```

---

### 4. **ุชุฏูู ุงูุชุญูู ุงูุชููุงุฆู (onAuthStateChanged)**

```
ุชุบููุฑ ูู ุญุงูุฉ ุงููุตุงุฏูุฉ
    โ
onAuthStateChanged ูุชู ุงุณุชุฏุนุงุคู
    โ
ุฅุฐุง isGoogleSignInRef.current === true: ุชุฌุงูู (Google sign-in ูุฏูุฑ)
    โ
ุฅุฐุง currentUser ููุฌูุฏ:
    checkUserExists() - ุงูุชุญูู ูู Firestore
    โ
    ุฅุฐุง ููุฌูุฏ: setUser() + ุญูุธ ูู localStorage
    ุฅุฐุง ุบูุฑ ููุฌูุฏ: handleUnauthorizedUser() - ุชุณุฌูู ุงูุฎุฑูุฌ
    โ
ุฅุฐุง currentUser === null:
    setUser(null) + ุญุฐู ูู localStorage
```

---

### 5. **ุชุฏูู ุงููุตูู ุฅูู ุตูุญุฉ ูุญููุฉ**

```
ุงููุณุชุฎุฏู ูุญุงูู ุงููุตูู ุฅูู ุตูุญุฉ ูุญููุฉ
    โ
onAuthStateChanged ูุชุญูู ูู ุงููุณุชุฎุฏู
    โ
ุฅุฐุง currentUser ููุฌูุฏ:
    getDoc() - ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู ูู Firestore
    โ
    ุฅุฐุง ููุฌูุฏ:
        ุฅุฐุง ุตูุญุฉ admin: ุงูุชุญูู ูู role === "admin"
        ุฅุฐุง role !== "admin": ุงูุชูุฌูู ุฅูู /home
        ุฅุฐุง role === "admin": ุงูุณูุงุญ ุจุงููุตูู
    ุฅุฐุง ุบูุฑ ููุฌูุฏ: signOut() โ ุงูุชูุฌูู ุฅูู /login
    โ
ุฅุฐุง currentUser === null:
    ุงูุชูุฌูู ุฅูู /login
```

---

## ๐ฆ ุงูุจูุงูุงุช ุงููุญููุธุฉ

### 1. **Firestore Collection: `users`**

**ุงููููู:**
```javascript
{
  uid: string,              // ูุนุฑู ุงููุณุชุฎุฏู ุงููุฑูุฏ
  name: string,             // ุงุณู ุงููุณุชุฎุฏู
  email: string,            // ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
  photoURL: string | null, // ุฑุงุจุท ุงูุตูุฑุฉ
  role: "user" | "admin",  // ุงูุตูุงุญูุฉ
  createdAt: Timestamp,    // ุชุงุฑูุฎ ุงูุฅูุดุงุก (ููุท ูููุณุชุฎุฏููู ุงูุฌุฏุฏ)
  updatedAt: Timestamp     // ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ
}
```

---

### 2. **localStorage**

**ุงูููุงุชูุญ:**
- `userName`: ุงุณู ุงููุณุชุฎุฏู
- `userPhoto`: ุฑุงุจุท ุตูุฑุฉ ุงููุณุชุฎุฏู
- `rememberMe`: (ุบูุฑ ูุณุชุฎุฏู ุญุงููุงู)

**ุงูุงุณุชุฎุฏุงู:**
- ุนุฑุถ ุงุณู ุงููุณุชุฎุฏู ุจุณุฑุนุฉ ูุจู ุฌูุจ ุงูุจูุงูุงุช ูู Firestore
- ุชุญุณูู ุงูุฃุฏุงุก

---

## ๐ก๏ธ ุงูุฃูุงู ูุงูุญูุงูุฉ

### 1. **Auth Guard**
ุฌููุน ุงูุตูุญุงุช ุงููุญููุฉ ุชุชุญูู ูู:
- ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firebase Auth
- ูุฌูุฏ ุงููุณุชุฎุฏู ูู Firestore
- ุงูุตูุงุญูุงุช (role) ููุตูุญุงุช ุงูุฎุงุตุฉ

### 2. **ุงูุชุญูู ุงููุฒุฏูุฌ**
- ุงูุชุญูู ูู Firebase Auth
- ุงูุชุญูู ูู Firestore (ูุถูุงู ูุฌูุฏ ุจูุงูุงุช ุงููุณุชุฎุฏู)

### 3. **ุงูุชุณุฌูู ุงูุฎุฑูุฌ ุงูุชููุงุฆู**
- ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ููุฌูุฏ ูู Firestore
- ุฅุฐุง ูุดู ุงูุชุญูู ูู ุงูุจูุงูุงุช

---

## ๐ง ุงูุฏูุงู ุงููุณุงุนุฏุฉ

### 1. **checkUserExists**
```javascript
// ูู AuthContext ู login/page.js
const checkUserExists = async (uid, retries = 3)
```
- ุงูุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ

### 2. **saveUserToFirestore**
```javascript
// ูู AuthContext ู login/page.js
const saveUserToFirestore = async (user, displayNameFallback, isNewUser)
```
- ุญูุธ/ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู

### 3. **handleUnauthorizedUser**
```javascript
// ูู AuthContext ููุท
const handleUnauthorizedUser = async ()
```
- ุชุณุฌูู ุงูุฎุฑูุฌ ูุงูุชูุธูู

---

## ๐ฑ ุงูุตูุญุงุช ุงููุณุชุฎุฏูุฉ

### 1. **ุตูุญุงุช ุชุณุชุฎุฏู AuthContext:**
- `app/login/page.js` - ุชุณุฌูู ุงูุฏุฎูู
- `app/home/page.js` - ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
- ุฌููุน ุงูุตูุญุงุช ุงููุญููุฉ

### 2. **ุตูุญุงุช ุชุณุชุฎุฏู onAuthStateChanged ูุจุงุดุฑุฉ:**
- `app/reports/page.js`
- `app/admin/page.js`
- `app/settings/page.js`
- `app/page.js` (Landing)

---

## โ๏ธ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### ุฃุฎุทุงุก Firebase Auth:
- `auth/invalid-credential`: ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ
- `auth/user-not-found`: ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ
- `auth/wrong-password`: ูููุฉ ุงููุฑูุฑ ุฎุงุทุฆุฉ
- `auth/email-already-in-use`: ุงูุจุฑูุฏ ูุณุชุฎุฏู
- `auth/weak-password`: ูููุฉ ุงููุฑูุฑ ุถุนููุฉ
- `auth/network-request-failed`: ูุดููุฉ ูู ุงูุงุชุตุงู
- `auth/too-many-requests`: ุชุฌุงูุฒ ุงููุญุงููุงุช
- `auth/user-disabled`: ุงูุญุณุงุจ ูุนุทู
- `auth/operation-not-allowed`: ุงูุทุฑููุฉ ุบูุฑ ููุนููุฉ
- `auth/popup-closed-by-user`: ุงููุณุชุฎุฏู ุฃุบูู ุงููุงูุฐุฉ
- `auth/popup-blocked`: ุชู ุญุธุฑ ุงููุงูุฐุฉ
- `auth/unauthorized-domain`: ุงููุทุงู ุบูุฑ ูุตุฑุญ

### ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
- ุนุฑุถ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ
- ุชุณุฌูู ุงูุฎุฑูุฌ ุงูุชููุงุฆู ุนูุฏ ุงููุดู
- ุฅุนุงุฏุฉ ุงูุชูุฌูู ุฅูู `/login` ุนูุฏ ุงูุญุงุฌุฉ

---

## ๐ ุชุญุณููุงุช ุงูุฃุฏุงุก

### 1. **ุงูุชูุฌูู ุงูููุฑู**
- ูุง ุงูุชุธุงุฑ ุบูุฑ ุถุฑูุฑู
- ุนุฑุถ ุงูุตูุญุฉ ููุฑุงู ูุน ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ

### 2. **ุงูุชุญููู ูู ุงูุฎูููุฉ**
- ุชุญููู ุงูุจูุงูุงุช ุงูุฅุถุงููุฉ ุจุนุฏ ุนุฑุถ ุงูุตูุญุฉ

### 3. **localStorage**
- ุญูุธ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ูููุตูู ุงูุณุฑูุน

### 4. **useCallback**
- ุชุญุณูู ุงูุฃุฏุงุก ุจุชุฎุฒูู ุงูุฏูุงู

---

## โ๏ธ ุงููุดุงูู ุงููุญุชููุฉ ูุญููููุง

### 1. **ูุดุงูู ูุธุงู ุชุณุฌูู ุงูุฏุฎูู**

#### ุฃ. **ูุดููุฉ: ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ูู Firebase Auth ููู ุบูุฑ ููุฌูุฏ ูู Firestore**

**ุงูุณุจุจ:**
- ุชู ุฅูุดุงุก ุญุณุงุจ ูู Firebase Auth ููู ูุดู ุญูุธู ูู Firestore
- ุญุฐู ุงููุณุชูุฏ ูู Firestore ูุฏููุงู
- ูุดููุฉ ูู ุงูุงุชุตุงู ุฃุซูุงุก ุฅูุดุงุก ุงูุญุณุงุจ

**ุงูุฃุนุฑุงุถ:**
- ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู ุจูุฌุงุญ ููู ูุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุชููุงุฆูุงู
- ุฑุณุงูุฉ ุฎุทุฃ: "ุงูุญุณุงุจ ุบูุฑ ูุณุฌู ูุฏููุง"
- ุงูุชูุฌูู ุงููุณุชูุฑ ุฅูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู

**ุงูุญู:**
```javascript
// ูู onAuthStateChanged
if (currentUser) {
  const userExists = await checkUserExists(currentUser.uid);
  if (!userExists) {
    await handleUnauthorizedUser(); // ุชุณุฌูู ุงูุฎุฑูุฌ ุงูุชููุงุฆู
  }
}
```

**ุงูููุงูุฉ:**
- ุงูุชุญูู ูู ุฅูุดุงุก ุงููุณุชูุฏ ุจุนุฏ `saveUserToFirestore`
- ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุนูุฏ ุงููุดู
- ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ุตุญูุญ

---

#### ุจ. **ูุดููุฉ: Race Condition ูู Google Sign-In**

**ุงูุณุจุจ:**
- `onAuthStateChanged` ูุชู ุงุณุชุฏุนุงุคู ุฃุซูุงุก ุนูููุฉ Google Sign-In
- ุชุญุฏูุซุงุช ูุชุนุฏุฏุฉ ูู ููุณ ุงูููุช

**ุงูุฃุนุฑุงุถ:**
- ุชุณุฌูู ุฏุฎูู ูุฒุฏูุฌ
- ุจูุงูุงุช ุบูุฑ ูุชุณูุฉ
- ุฃุฎุทุงุก ูู ุงูุชุญูู

**ุงูุญู:**
```javascript
// ุงุณุชุฎุฏุงู isGoogleSignInRef ูููุน ุงูุชุฏุงุฎู
const isGoogleSignInRef = useRef(false);

// ูู signInWithGoogle
isGoogleSignInRef.current = true;
// ... ุนูููุฉ ุชุณุฌูู ุงูุฏุฎูู
isGoogleSignInRef.current = false;

// ูู onAuthStateChanged
if (isGoogleSignInRef.current) {
  return; // ุชุฌุงูู ุงูุชุญุฏูุซ
}
```

---

#### ุฌ. **ูุดููุฉ: ูุดู ุฅูุดุงุก ุงููุณุชูุฏ ูู Firestore**

**ุงูุณุจุจ:**
- ูุดููุฉ ูู ุงูุงุชุตุงู
- ููุงุนุฏ ุงูุฃูุงู ูู Firestore
- ุฎุทุฃ ูู ุงูุจูุงูุงุช

**ุงูุฃุนุฑุงุถ:**
- ุฑุณุงูุฉ: "Failed to create user document"
- ุญุณุงุจ ููุฌูุฏ ูู Auth ููู ุบูุฑ ููุฌูุฏ ูู Firestore
- ูุดู ุชุณุฌูู ุงูุฏุฎูู

**ุงูุญู:**
```javascript
// ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุน ุงูุชุญูู
let verified = await checkUserExists(user.uid);
let retries = 3;

while (!verified && retries > 0) {
  await new Promise(resolve => setTimeout(resolve, 150));
  verified = await checkUserExists(user.uid);
  retries--;
}

if (!verified) {
  // ูุญุงููุฉ ุฃุฎูุฑุฉ
  await saveUserToFirestore(user, name, true);
  await new Promise(resolve => setTimeout(resolve, 200));
  verified = await checkUserExists(user.uid);
}
```

---

#### ุฏ. **ูุดููุฉ: ุชุญุฏูุซ Profile ุจุนุฏ ุฅูุดุงุก ุงูุญุณุงุจ**

**ุงูุณุจุจ:**
- `updateProfile` ูุฏ ูุณุชุบุฑู ููุชุงู
- Firebase Auth ูุฏ ูุง ูุญุฏุซ ููุฑุงู

**ุงูุฃุนุฑุงุถ:**
- ุงูุงุณู ูุง ูุธูุฑ ุจุนุฏ ุฅูุดุงุก ุงูุญุณุงุจ
- `user.displayName` ูููู `null`

**ุงูุญู:**
```javascript
if (name && name.trim()) {
  try {
    await updateProfile(user, { displayName: name });
    await new Promise(resolve => setTimeout(resolve, 200)); // ุงูุชุธุงุฑ ุงูุชุญุฏูุซ
  } catch (profileError) {
    // Silently fail - profile update is not critical
  }
}
```

---

#### ูู. **ูุดููุฉ: Popup Blocked ูู Google Sign-In**

**ุงูุณุจุจ:**
- ุงููุชุตูุญ ูุญุธุฑ ุงูููุงูุฐ ุงูููุจุซูุฉ
- ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ูู ุงููุชุตูุญ

**ุงูุฃุนุฑุงุถ:**
- ุฑุณุงูุฉ: "ุชู ุญุธุฑ ุงููุงูุฐุฉ ุงูููุจุซูุฉ"
- ูุดู ุชุณุฌูู ุงูุฏุฎูู ุจู Google

**ุงูุญู:**
```javascript
if (err.code === "auth/popup-blocked") {
  showError("ุชู ุญุธุฑ ุงููุงูุฐุฉ ุงูููุจุซูุฉ. ูุฑุฌู ุงูุณูุงุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ ูู ูุฐุง ุงููููุน");
}
```

**ุงูููุงูุฉ:**
- ุฅุฑุดุงุฏ ุงููุณุชุฎุฏู ููุณูุงุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ
- ุงุณุชุฎุฏุงู Redirect ุจุฏูุงู ูู Popup (ุฎูุงุฑ ูุณุชูุจูู)

---

#### ู. **ูุดููุฉ: Invalid Credential**

**ุงูุณุจุจ:**
- ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ
- ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ูู Firebase Console

**ุงูุฃุนุฑุงุถ:**
- ุฑุณุงูุฉ: "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ"
- ูุดู ุชุณุฌูู ุงูุฏุฎูู

**ุงูุญู:**
```javascript
if (err.code === "auth/invalid-credential") {
  errorMessage = "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ";
}
```

---

#### ุฒ. **ูุดููุฉ: Email Already in Use**

**ุงูุณุจุจ:**
- ูุญุงููุฉ ุฅูุดุงุก ุญุณุงุจ ุจุจุฑูุฏ ุฅููุชุฑููู ููุฌูุฏ

**ุงูุฃุนุฑุงุถ:**
- ุฑุณุงูุฉ: "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุฎุฏู ุจุงููุนู"
- ูุดู ุฅูุดุงุก ุงูุญุณุงุจ

**ุงูุญู:**
```javascript
if (err.code === "auth/email-already-in-use") {
  errorMessage = "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุฎุฏู ุจุงููุนู. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุจุฏูุงู ูู ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ";
}
```

---

#### ุญ. **ูุดููุฉ: Network Request Failed**

**ุงูุณุจุจ:**
- ุนุฏู ูุฌูุฏ ุงุชุตุงู ุจุงูุฅูุชุฑูุช
- ูุดููุฉ ูู ุฎุงุฏู Firebase

**ุงูุฃุนุฑุงุถ:**
- ุฑุณุงูุฉ: "ูุดููุฉ ูู ุงูุงุชุตุงู ุจุงูุดุจูุฉ"
- ูุดู ุฌููุน ุนูููุงุช ุงููุตุงุฏูุฉ

**ุงูุญู:**
```javascript
if (err.code === "auth/network-request-failed") {
  errorMessage = "ูุดููุฉ ูู ุงูุงุชุตุงู ุจุงูุดุจูุฉ. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู";
}
```

---

### 2. **ูุดุงูู ูุธุงู ุงูุชุญูู ูู ุจูุงูุงุช ุงููุณุชุฎุฏู**

#### ุฃ. **ูุดููุฉ: ุงูุชุญูู ุงูุจุทูุก ูู Firestore**

**ุงูุณุจุจ:**
- ุงุชุตุงู ุจุทูุก
- ุงุณุชุนูุงูุงุช ูุชุนุฏุฏุฉ
- ุนุฏู ุงุณุชุฎุฏุงู Cache

**ุงูุฃุนุฑุงุถ:**
- ุชุฃุฎูุฑ ูู ุนุฑุถ ุงูุตูุญุฉ
- Loading ุทููู

**ุงูุญู:**
```javascript
// ุงุณุชุฎุฏุงู localStorage ููุจูุงูุงุช ุงูุฃุณุงุณูุฉ
if (typeof window !== "undefined") {
  const savedName = localStorage.getItem("userName");
  if (savedName) {
    setUserName(savedName); // ุนุฑุถ ููุฑู
  }
}

// ุชุญููู ุงูุจูุงูุงุช ุงูุฅุถุงููุฉ ูู ุงูุฎูููุฉ
const loadUserData = async () => {
  // ุนุฑุถ ุงูุตูุญุฉ ุฃููุงู
  setLoading(false);
  
  // ุซู ุชุญููู ุงูุจูุงูุงุช
  const userDoc = await getDoc(doc(db, "users", user.uid));
  // ...
};
```

---

#### ุจ. **ูุดููุฉ: Role ุบูุฑ ููุฌูุฏ ุฃู ุบูุฑ ุตุญูุญ**

**ุงูุณุจุจ:**
- ุญุณุงุจ ูุฏูู ุจุฏูู role
- ุฎุทุฃ ูู ุญูุธ role
- ุชุนุฏูู ูุฏูู ูู Firestore

**ุงูุฃุนุฑุงุถ:**
- `userRole` ูููู `null` ุฃู `undefined`
- ูุดุงูู ูู ุงูุตูุงุญูุงุช

**ุงูุญู:**
```javascript
// ูู saveUserToFirestore
if (isNewUser || !userExists) {
  userData.role = "user"; // ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ
} else if (userDoc.exists() && userDoc.data().role) {
  userData.role = userDoc.data().role; // ุงูุงุญุชูุงุธ ุจุงูู role ุงูููุฌูุฏ
} else {
  userData.role = "user"; // ุฅุถุงูุฉ role ุฅุฐุง ูู ููู ููุฌูุฏ
}

// ูู ุงูุตูุญุงุช
const userData = userDoc.data();
setUserRole(userData.role || "user"); // ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ
```

---

#### ุฌ. **ูุดููุฉ: ุงูุชุญูู ูู Role ูู ุตูุญุฉ Admin**

**ุงูุณุจุจ:**
- ุงููุณุชุฎุฏู ุงูุนุงุฏู ูุญุงูู ุงููุตูู ูุตูุญุฉ Admin
- Role ุบูุฑ ุตุญูุญ

**ุงูุฃุนุฑุงุถ:**
- ุชูุฌูู ุงููุณุชุฎุฏููู ุงูุนุงุฏููู ุฅูู `/home`
- ุฑุณุงุฆู ุฎุทุฃ

**ุงูุญู:**
```javascript
// ูู admin/page.js
const userData = userDoc.data();

if (userData?.role !== "admin") {
  router.push("/home"); // ุชูุฌูู ุงููุณุชุฎุฏููู ุงูุนุงุฏููู
  return;
}

setUserRole(userData?.role || "admin");
```

---

#### ุฏ. **ูุดููุฉ: ุจูุงูุงุช localStorage ุบูุฑ ูุชุณูุฉ**

**ุงูุณุจุจ:**
- ุชุญุฏูุซ ุงูุจูุงูุงุช ูู Firestore ููู localStorage ูู ููุญุฏุซ
- ุญุฐู localStorage ูุฏููุงู
- ุจูุงูุงุช ูุฏููุฉ

**ุงูุฃุนุฑุงุถ:**
- ุนุฑุถ ุงุณู ุฎุงุทุฆ
- ุตูุฑุฉ ูุฏููุฉ

**ุงูุญู:**
```javascript
// ุชุญุฏูุซ localStorage ุนูุฏ ุชุบููุฑ ุงูุจูุงูุงุช
useEffect(() => {
  if (user) {
    const name = user.displayName || user.email || "";
    localStorage.setItem("userName", name);
    if (user.photoURL) {
      localStorage.setItem("userPhoto", user.photoURL);
    }
  }
}, [user]);

// ุงุณุชุฎุฏุงู localStorage ูู fallback
const savedName = localStorage.getItem("userName");
if (savedName && !userName) {
  setUserName(savedName);
}
```

---

#### ูู. **ูุดููุฉ: Multiple Auth State Listeners**

**ุงูุณุจุจ:**
- ุนุฏุฉ ุตูุญุงุช ุชุณุชูุน ูุชุบููุฑุงุช Auth State
- ุนุฏู ุชูุธูู ุงูู listeners

**ุงูุฃุนุฑุงุถ:**
- ุงุณุชุฏุนุงุกุงุช ูุชุนุฏุฏุฉ
- ุงุณุชููุงู ููุงุฑุฏ ุฒุงุฆุฏ
- ุณููู ุบูุฑ ูุชููุน

**ุงูุญู:**
```javascript
// ุชูุธูู ุงูู listener ุนูุฏ ุฅูุบุงุก ุงูุชุญููู
useEffect(() => {
  const unsubscribe = onAuthStateChanged(auth, (user) => {
    // ...
  });

  return () => unsubscribe(); // ุชูุธูู
}, []);
```

---

#### ู. **ูุดููุฉ: ุงูุชุญูู ูู ุงููุณุชุฎุฏู ูู ูู ุตูุญุฉ**

**ุงูุณุจุจ:**
- ูู ุตูุญุฉ ุชุชุญูู ูู ุงููุณุชุฎุฏู ุจุดูู ูููุตู
- ุชูุฑุงุฑ ุงูููุฏ

**ุงูุฃุนุฑุงุถ:**
- ููุฏ ููุฑุฑ
- ุตุนูุจุฉ ุงูุตูุงูุฉ

**ุงูุญู:**
```javascript
// ุงุณุชุฎุฏุงู AuthContext ุจุฏูุงู ูู onAuthStateChanged ูู ูู ุตูุญุฉ
const { user, loading } = useAuth();

useEffect(() => {
  if (!user && !loading) {
    router.replace("/login");
  }
}, [user, loading, router]);
```

---

#### ุฒ. **ูุดููุฉ: Timestamp Conversion**

**ุงูุณุจุจ:**
- `createdAt` ู `updatedAt` ูู Firestore ูู Timestamp
- ูุญุงููุฉ ุงุณุชุฎุฏุงููุง ูุจุงุดุฑุฉ ูู Date

**ุงูุฃุนุฑุงุถ:**
- "Invalid Date"
- ุฃุฎุทุงุก ูู ุนุฑุถ ุงูุชุงุฑูุฎ

**ุงูุญู:**
```javascript
// ุชุญููู Timestamp ุฅูู Date
let createdAtDate = null;
if (userItem.createdAt) {
  if (typeof userItem.createdAt.toDate === 'function') {
    createdAtDate = userItem.createdAt.toDate();
  } else if (userItem.createdAt.seconds) {
    createdAtDate = new Date(userItem.createdAt.seconds * 1000);
  } else {
    createdAtDate = new Date(userItem.createdAt);
  }
}
```

---

### 3. **ูุดุงูู ุนุงูุฉ**

#### ุฃ. **ูุดููุฉ: Session Expiration**

**ุงูุณุจุจ:**
- Firebase Auth sessions ุชูุชูู ุจุนุฏ ูุชุฑุฉ
- ุนุฏู ูุนุงูุฌุฉ ุงูุชูุงุก ุงูุฌูุณุฉ

**ุงูุฃุนุฑุงุถ:**
- ุชุณุฌูู ุฎุฑูุฌ ุชููุงุฆู ุบูุฑ ูุชููุน
- ููุฏุงู ุงูุจูุงูุงุช

**ุงูุญู:**
```javascript
// ุงูุงุณุชูุงุน ูุชุบููุฑุงุช Auth State
onAuthStateChanged(auth, (user) => {
  if (!user) {
    // ุชุณุฌูู ุงูุฎุฑูุฌ ุงูุชููุงุฆู
    handleUnauthorizedUser();
  }
});
```

---

#### ุจ. **ูุดููุฉ: CORS ู Unauthorized Domain**

**ุงูุณุจุจ:**
- ุงููุทุงู ุบูุฑ ูุตุฑุญ ุจู ูู Firebase Console
- ูุดุงูู CORS

**ุงูุฃุนุฑุงุถ:**
- ุฑุณุงูุฉ: "ุงููุทุงู ุบูุฑ ูุตุฑุญ ุจู"
- ูุดู ุชุณุฌูู ุงูุฏุฎูู

**ุงูุญู:**
1. ุฅุถุงูุฉ ุงููุทุงู ูู Firebase Console
2. Authentication > Settings > Authorized domains
3. ุฅุถุงูุฉ `localhost` ููุชุทููุฑ

---

#### ุฌ. **ูุดููุฉ: Firestore Security Rules**

**ุงูุณุจุจ:**
- ููุงุนุฏ ุงูุฃูุงู ุชููุน ุงููุฑุงุกุฉ/ุงููุชุงุจุฉ
- ุนุฏู ุฅุนุฏุงุฏ Rules ุจุดูู ุตุญูุญ

**ุงูุฃุนุฑุงุถ:**
- Permission denied
- ูุดู ุญูุธ/ุฌูุจ ุงูุจูุงูุงุช

**ุงูุญู:**
```javascript
// ูุซุงู ุนูู Firestore Rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
```

---

### 4. **ุฃูุถู ุงูููุงุฑุณุงุช ูุชุฌูุจ ุงููุดุงูู**

#### โ **ุงูุชุญูู ุงููุฒุฏูุฌ:**
- ุฏุงุฆูุงู ุงูุชุญูู ูู Firebase Auth ู Firestore
- ูุง ุชุนุชูุฏ ุนูู Auth ููุท

#### โ **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
- ูุนุงูุฌุฉ ุฌููุน ุงูุฃุฎุทุงุก ุงููุญุชููุฉ
- ุนุฑุถ ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู

#### โ **ุฅุนุงุฏุฉ ุงููุญุงููุฉ:**
- ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุนูุฏ ูุดู ุงูุนูููุงุช ุงูุญุฑุฌุฉ
- ุงุณุชุฎุฏุงู exponential backoff

#### โ **ุงูุชูุธูู:**
- ุชูุธูู ุงูู listeners ุนูุฏ ุฅูุบุงุก ุงูุชุญููู
- ุญุฐู ุงูุจูุงูุงุช ูู localStorage ุนูุฏ ุชุณุฌูู ุงูุฎุฑูุฌ

#### โ **ุงูุชุญุณูู:**
- ุงุณุชุฎุฏุงู localStorage ููุจูุงูุงุช ุงูุฃุณุงุณูุฉ
- ุชุญููู ุงูุจูุงูุงุช ุงูุฅุถุงููุฉ ูู ุงูุฎูููุฉ
- ุชูููู ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช

#### โ **ุงูุฃูุงู:**
- ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูู ูู ุตูุญุฉ
- ุงุณุชุฎุฏุงู Firestore Security Rules
- ุนุฏู ุงูุซูุฉ ูู ุงูุจูุงูุงุช ูู Client

---

### 5. **ูุงุฆูุฉ ูุญุต ุงููุดุงูู (Troubleshooting Checklist)**

ุนูุฏ ููุงุฌูุฉ ูุดููุฉ ูู ุชุณุฌูู ุงูุฏุฎููุ ุชุญูู ูู:

- [ ] ูู ุงููุณุชุฎุฏู ููุฌูุฏ ูู Firebase Auth Consoleุ
- [ ] ูู ุงููุณุชุฎุฏู ููุฌูุฏ ูู Firestore collection `users`ุ
- [ ] ูู `role` ููุฌูุฏ ูุตุญูุญ ูู Firestoreุ
- [ ] ูู localStorage ูุญุชูู ุนูู ุงูุจูุงูุงุช ุงูุตุญูุญุฉุ
- [ ] ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ูุนููุ
- [ ] ูู ุงููุทุงู ูุตุฑุญ ุจู ูู Firebase Console๏ผ
- [ ] ูู Firestore Security Rules ุตุญูุญุฉุ
- [ ] ูู ููุงู ุฃุฎุทุงุก ูู Consoleุ
- [ ] ูู ุงูู listeners ูุชู ุชูุธูููุง ุจุดูู ุตุญูุญุ
- [ ] ูู ููุงู Race Conditionsุ

---

### 6. **ูุดููุฉ: ุงูุชูุฌูู ุงููุฒุฏูุฌ ุนูุฏ Reload (Home Page)**

**ุงูุณุจุจ:**
- ุนูุฏ ุนูู reload ููุตูุญุฉุ `authLoading` ูููู `true` ูู ุงูุจุฏุงูุฉ
- `user` ูููู `null` ูุคูุชุงู ูุจู ุชุญููู ุญุงูุฉ ุงููุตุงุฏูุฉ
- ุฅุฐุง ุชุญูููุง ูู `!user` ูุจุงุดุฑุฉ ุจุฏูู ุงูุชุธุงุฑ `authLoading`ุ ุณูุชู ุงูุชูุฌูู ุฅูู `/login`
- ุซู ุนูุฏูุง ูุชู ุชุญููู `user` ูู AuthContextุ ุณูุชู ุงูุชูุฌูู ูุฑุฉ ุฃุฎุฑู ุฅูู `/home`

**ุงูุฃุนุฑุงุถ:**
- ุนูุฏ reload ุตูุญุฉ `/home`ุ ูุชู ุงูุชูุฌูู ุฅูู `/login` ุซู ุงูุนูุฏุฉ ุฅูู `/home`
- ูููุถ ุณุฑูุน ุจูู ุงูุตูุญุชูู
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ

**ุงูุญู:**
```javascript
// ูู home/page.js
useEffect(() => {
  // ุงูุงูุชุธุงุฑ ุญุชู ูุชู ุชุญููู ุญุงูุฉ ุงููุตุงุฏูุฉ ูุจู ุงูุชุญูู
  if (authLoading) {
    return; // ูุง ุชูุนู ุดูุก ุฃุซูุงุก ุงูุชุญููู
  }

  // ุจุนุฏ ุงูุชูุงุก ุงูุชุญูููุ ุฅุฐุง ูู ููู ููุงู userุ ุงูุชูุฌูู ุฅูู login
  if (!user) {
    router.replace("/login");
    return;
  }
  // ...
}, [user, authLoading, router, ...]);
```

**ุงูููุงูุฉ:**
- ุฏุงุฆูุงู ุงูุชุธุฑ `authLoading` ูุจู ุงูุชุญูู ูู `user`
- ูุง ุชุชุญูู ูู `user` ูุจุงุดุฑุฉ ุจุฏูู ุงูุชุธุงุฑ ุชุญููู ุญุงูุฉ ุงููุตุงุฏูุฉ

---

### 7. **ููุงุญุธุฉ: signInWithPopup vs signInWithRedirect**

**ุงููุดุฑูุน ุงูุญุงูู ูุณุชุฎุฏู:**
- โ `signInWithPopup`: ููุชุญ ูุงูุฐุฉ ููุจุซูุฉ ูุงุฎุชูุงุฑ ุญุณุงุจ Google
- โ `signInWithRedirect`: ุบูุฑ ูุณุชุฎุฏู ูู ุงููุดุฑูุน

**ุงููุฑู:**
- `signInWithPopup`: 
  - ููุชุญ ูุงูุฐุฉ ููุจุซูุฉ
  - ุงููุณุชุฎุฏู ูุฎุชุงุฑ ุงูุญุณุงุจ ูู ุงููุงูุฐุฉ
  - ูุนูุฏ ุฅูู ููุณ ุงูุตูุญุฉ
  - ูุฏ ูุชู ุญุธุฑู ูู ุงููุชุตูุญ
  
- `signInWithRedirect`:
  - ูุนูุฏ ุงูุชูุฌูู ุฅูู ุตูุญุฉ Google
  - ุงููุณุชุฎุฏู ูุณุฌู ุงูุฏุฎูู
  - ูุนูุฏ ุฅูู ุงูุชุทุจูู
  - ูุง ูุชู ุญุธุฑู ุนุงุฏุฉ

**ูู ุญุงูุฉ ุงูุฑุบุจุฉ ูู ุงูุชุบููุฑ:**
```javascript
// ุจุฏูุงู ูู signInWithPopup
import { signInWithRedirect } from "firebase/auth";

const result = await signInWithRedirect(auth, provider);
// ูุง ุญุงุฌุฉ ูู result - ุณูุชู ุงูุชูุฌูู ุชููุงุฆูุงู
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุชุญูู ุงููุฒุฏูุฌ**: ุฏุงุฆูุงู ุงูุชุญูู ูู Firebase Auth ู Firestore
2. **ุฅุนุงุฏุฉ ุงููุญุงููุฉ**: `checkUserExists` ูุนูุฏ ุงููุญุงููุฉ ุญุชู 3 ูุฑุงุช
3. **Google Sign-In**: ูุณุชุฎุฏู `isGoogleSignInRef` ูููุน ุงูุชุฏุงุฎู
4. **Role Management**: `role` ูุญููุธ ูู Firestore ูููุณ ูู Auth
5. **ุงูุชูุธูู**: ุญุฐู ุงูุจูุงูุงุช ูู localStorage ุนูุฏ ุชุณุฌูู ุงูุฎุฑูุฌ

---

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

### ููุฒุงุช ูุญุชููุฉ:
- [ ] ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ (Forgot Password)
- [ ] ุชุณุฌูู ุงูุฏุฎูู ุจู Facebook
- [ ] ุชุณุฌูู ุงูุฏุฎูู ุจู Apple
- [ ] Two-Factor Authentication (2FA)
- [ ] Session Management
- [ ] Remember Me functionality

---

## ๐ ุงููุฑุงุฌุน

- [Firebase Authentication Documentation](https://firebase.google.com/docs/auth)
- [Firebase Firestore Documentation](https://firebase.google.com/docs/firestore)
- [Next.js Authentication](https://nextjs.org/docs/authentication)

---

**ุขุฎุฑ ุชุญุฏูุซ**: 2024
**ุงูุฅุตุฏุงุฑ**: 1.0.0

